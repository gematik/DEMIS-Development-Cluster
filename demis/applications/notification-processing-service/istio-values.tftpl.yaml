# Application Information
appName: "notification-processing-service"
appNamespace: "${namespace}" # defaults to Release.Namespace
# Settings for the Kubernetes Service Object for the Application
appServiceType: ClusterIP
appServicePortExternal: 8080
appServicePortTarget: 8080
appServicePortProtocol: TCP
appServicePortName: http

# Istio Information
# the List of the Istio Gateway Objects to be used for external cluster access
virtualServiceGateways: 
  - ${cluster_gateway}
# the List of the Hostnames/Domains that should match the VirtualService definition (external)
virtualServiceDomains: 
  - ${core_hostname}

# HTTP Rules for internal endpoints - https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute
# The "route" part is generated using the destination subset information
virtualServiceHttpRules:
%{ if feature_flag_new_api_endpoints ~}
  - match:
    - uri:
        prefix: /hospitalization/fhir/
    - uri:
        prefix: /notification-api/fhir/
    - uri:
        prefix: /
%{ else ~}
  - match:
    - uri:
        prefix: /hospitalization
    - uri:
        prefix: /notification-api
%{ endif ~}
    rewrite:
      uri: /
%{ if http_timeout_retry_block != null ~}
    ${indent(4, http_timeout_retry_block)}
%{ endif ~}

virtualServiceExternalHttpRules:
%{ if support_fhir_api_versions && length(fhir_api_versions) > 0 && feature_flag_new_api_endpoints ~}
%{for version in distinct([ for v in fhir_api_versions: join("",regex("(0|[1-9]\\d*)",v))]) ~}
  - headers:
      request:
        set:
          x-fhir-api-request-origin: external
          x-fhir-api-submission-type: disease
          x-fhir-api-version: v${version}
          x-fhir-profile: fhir-profile-snapshots
    match:
    - uri:
        prefix: ${context_path}/notifications/disease/v${version}/fhir/
      ignoreUriCase: true
    rewrite:
      uri: /
  - headers:
      request:
        set:
          x-fhir-api-request-origin: external
          x-fhir-api-submission-type: pathogen
          x-fhir-api-version: v${version}
          x-fhir-profile: fhir-profile-snapshots
    match:
    - uri:
        prefix: ${context_path}/notifications/pathogen/v${version}/fhir/
      ignoreUriCase: true
    rewrite:
      uri: /
%{ if http_timeout_retry_block != null ~}
    ${indent(4, http_timeout_retry_block)}
%{ endif ~}
%{ endfor ~}
%{ endif ~}
%{ if feature_flag_new_api_endpoints ~}
  - headers:
      request:
        set:
          x-fhir-api-request-origin: external
          x-fhir-api-submission-type: disease
    match:
    - uri:
        prefix: ${context_path}/hospitalization/fhir
    rewrite:
      uri: /
  - headers:
      request:
        set:
          x-fhir-api-request-origin: external
          x-fhir-api-submission-type: pathogen
    match:
    - uri:
        prefix: ${context_path}/notification-api/fhir
    rewrite:
      uri: /
%{ else ~}
  - match:
    - uri:
        prefix: ${context_path}/hospitalization
    - uri:
        prefix: ${context_path}/notification-api
    rewrite:
      uri: /
%{ endif ~}
%{ if http_timeout_retry_block != null ~}
    ${indent(4, http_timeout_retry_block)}
%{ endif ~}
