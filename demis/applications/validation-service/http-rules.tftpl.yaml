%{ for version in distinct(compact([ for subset in concat(tolist(subsets.main), tolist(subsets.canary)): join("",regex("(0|[1-9]\\d*)",subset.labels.fhirProfileVersion)) if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion))) ])) ~}
- match:
    - headers:
        x-fhir-api-version:
          exact: v${version}
  route:
%{ for s in [ for subset in concat(tolist(subsets.main), tolist(subsets.canary)): subset if ((subset.mode == "distributed") && try(startswith(subset.labels.fhirProfileVersion, version), false))] ~}
    - destination:
        host: {{ include "routing.application.host" . }}
        subset: ${s.name}
        port:
          number: {{ .Values.appServicePortExternal }}
      weight: ${s.weight}
%{ endfor ~}
%{ endfor ~}
%{ if length([for sub in concat(tolist(subsets.main), tolist(subsets.canary)): sub if (sub.mode == "dedicated")]) >= 1 || (length(distinct(compact([for subset in tolist(subsets.main): subset.labels.fhirProfileVersion if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))]))) <= 1 && length(distinct(compact([for subset in tolist(subsets.canary): subset.labels.fhirProfileVersion if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))]))) <= 1) ~}
- route:
%{ endif  ~}
%{ for s in [ for subset in concat(tolist(subsets.main), tolist(subsets.canary)): subset if (subset.mode == "dedicated")] ~}
    - destination:
        host: {{ include "routing.application.host" . }}
        subset: ${s.name}
        port:
          number: {{ .Values.appServicePortExternal }}
      weight: ${s.weight}
%{ endfor ~}
%{ if length(distinct(compact([for subset in tolist(subsets.main): subset.labels.fhirProfileVersion if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))]))) < 2 ~}
%{ for s in [ for subset in tolist(subsets.main): subset if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))] ~}
    - destination:
        host: {{ include "routing.application.host" . }}
        subset: ${s.name}
        port:
          number: {{ .Values.appServicePortExternal }}
      weight: ${s.weight}
%{ endfor ~}
%{ endif ~}
%{ if length(distinct(compact([for subset in tolist(subsets.canary): subset.labels.fhirProfileVersion if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))]))) < 2 }
%{ for s in [ for subset in tolist(subsets.canary): subset if ((subset.mode == "distributed") && can(length(subset.labels.fhirProfileVersion)))] ~}
    - destination:
        host: {{ include "routing.application.host" . }}
        subset: ${s.name}
        port:
          number: {{ .Values.appServicePortExternal }}
      weight: ${s.weight}
%{ endfor ~}
%{ endif ~}
